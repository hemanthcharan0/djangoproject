<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Smartora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --header-bg: #ffffff;
            --text-color: #333333;
            --accent-color: #000000;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding-top: 80px;
        }

        .navbar {
            position: fixed;
            top: 0; width: 100%; height: 70px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px; z-index: 1000; box-sizing: border-box;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Navigation Links */
        .nav-link { color: #64748b; text-decoration: none; font-weight: 600; margin-right: 20px; cursor: pointer; }
        .nav-link.active { color: var(--accent-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; }

        /* Filter Section */
        .filter-section {
            background: white; padding: 20px; border-radius: 12px;
            margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 15px;
            box-shadow: var(--shadow); align-items: center;
        }
        .filter-section input, .filter-section select { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; outline: none;}
        .btn-filter { background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }

        /* Product Cards (Collections) */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border-color); display: flex; flex-direction: column; transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); }
        .product-img { width: 100%; height: 220px; object-fit: cover; }
        .product-body { padding: 20px; flex-grow: 1; }
        .product-price { font-weight: 700; font-size: 1.25rem; margin-bottom: 15px; }

        /* Dynamic Cart Controls */
        .cart-controls { display: flex; align-items: center; justify-content: space-between; background: #f1f5f9; border-radius: 8px; padding: 5px; width: 100%; box-sizing: border-box;}
        .cart-controls button { background: white; border: 1px solid var(--border-color); border-radius: 6px; width: 30px; height: 30px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center;}
        .btn-add-main { background: var(--accent-color); color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }

        /* Table Styling (Cart & Orders) */
        .custom-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        .custom-table th { background: #f8f9fa; padding: 15px; text-align: left; color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
        .custom-table td { padding: 20px; border-top: 1px solid var(--border-color); vertical-align: middle; }
        
        /* Thumbnail Styling */
        .thumb-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 15px; border: 1px solid #eee; }
        .item-cell { display: flex; align-items: center; }

        /* Status Badges */
        .badge-pending { background: #fff7ed; color: #9a3412; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; border: 1px solid #ffedd5; }

        .content-section { display: none; }
        .content-section.active { display: block; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div onclick="showSection('dashboard', document.getElementById('link-dash'))" style="cursor:pointer; font-weight:bold; font-size:1.5rem; font-family:'Nunito';">Smartora</div>
        <div class="nav-links">
            <a id="link-dash" class="nav-link active" onclick="showSection('dashboard', this)">Dashboard</a>
            <a id="link-collections" class="nav-link" onclick="showSection('collections', this)">Collections</a>
            <a id="link-orders" class="nav-link" onclick="showSection('orders', this)">Orders</a>
            <a id="link-cart" class="nav-link" onclick="showSection('cart', this)">Cart (<span id="cart-count">0</span>)</a>
        </div>
        <div style="font-weight:600;">{{ request.user.username }} | <a href="{% url 'index' %}" style="color:#ef4444; text-decoration:none;">Logout</a></div>
    </nav>

    <div class="container">
        
        <div id="dashboard-section" class="content-section active">
            <h2 style="font-size: 2rem; font-weight: 700;">Welcome back, {{ request.user.username }}!</h2>
            <p style="color: #64748b;">Ready to find something new? Check out our latest collections.</p>
        </div>

        <div id="collections-section" class="content-section">
            <form method="GET" class="filter-section">
                <input type="text" name="q" placeholder="Search products..." value="{{ request.GET.q|default:'' }}">
                <select name="category">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"i" %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="min_price" placeholder="Min Price" value="{{ request.GET.min_price }}">
                <input type="number" name="max_price" placeholder="Max Price" value="{{ request.GET.max_price }}">
                <button type="submit" class="btn-filter">Apply Filters</button>
            </form>

            <div class="products-grid">
                {% for product in products %}
                <div class="product-card">
                    <img src="{{ product.image.url }}" class="product-img">
                    <div class="product-body">
                        <h4 style="margin:0; font-size:1.1rem;">{{ product.title }}</h4>
                        <p style="color:#64748b; font-size:0.8rem; margin: 5px 0 10px 0;">{{ product.category.name|default:"General" }}</p>
                        <div class="product-price">Rs. {{ product.price }}</div>
                        <div id="cart-btn-container-{{ product.id }}">
                            <button class="btn-add-main" onclick="updateCart('{{ product.id }}', 'add')">Add to Cart</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="orders-section" class="content-section">
            <h2 style="margin-bottom:20px;">Order History</h2>
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Product Details</th>
                        <th>Price Paid</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td style="font-weight:600; color:#64748b;">#ORDERID-{{ order.id }}</td>
                        <td>
                            <div class="item-cell">
                                <img src="{{ order.product.image.url }}" class="thumb-img">
                                <div>
                                    <div style="font-weight:600;">{{ order.product.title }}</div>
                                    <div style="font-size:0.8rem; color:#64748b;">Qty: {{ order.quantity }}</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-weight:700;">Rs. {{ order.price }}</td>
                        <td><span class="badge-pending">{{ order.status }}</span></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align:center; padding:40px; color:#94a3b8;">No orders found yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="cart-section" class="content-section">
            <h2 style="margin-bottom:20px;">Your Shopping Cart</h2>
            <div id="cart-items-display">
                </div>
            <div id="cart-checkout-box" style="margin-top:30px; text-align:right; display:none; background:white; padding:30px; border-radius:12px; box-shadow:var(--shadow);">
                <h3 style="margin:0 0 20px 0;">Grand Total: <span style="color:var(--accent-color);">Rs. <span id="cart-total-amount">0</span></span></h3>
                <button onclick="checkout()" style="background:black; color:white; padding:15px 50px; border-radius:8px; border:none; font-weight:700; cursor:pointer; font-size:1.1rem;">Place Order Now</button>
            </div>
        </div>

    </div>

    <script>
        function showSection(id, element) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id + '-section').classList.add('active');
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            if(element) element.classList.add('active');
            if(id === 'cart') loadCart();
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function updateCart(productId, action) {
            const csrftoken = getCookie('csrftoken');
            let url = action === 'add' ? `/userdashboard/add_to_cart/${productId}/` : `/userdashboard/cart_update/0/`;
            let body = action === 'add' ? null : JSON.stringify({ product_id: productId, action: action });

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
                body: body
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    renderButton(productId, data.quantity);
                    updateBadge();
                    if(document.getElementById('cart-section').classList.contains('active')) loadCart();
                }
            });
        }

        function renderButton(productId, qty) {
            const container = document.getElementById(`cart-btn-container-${productId}`);
            if (!container) return;
            if (qty > 0) {
                container.innerHTML = `
                    <div class="cart-controls">
                        <button onclick="updateCart('${productId}', 'decrease')"><i class="fas fa-minus"></i></button>
                        <span style="font-weight:bold;">${qty}</span>
                        <button onclick="updateCart('${productId}', 'increase')"><i class="fas fa-plus"></i></button>
                    </div>`;
            } else {
                container.innerHTML = `<button class="btn-add-main" onclick="updateCart('${productId}', 'add')">Add to Cart</button>`;
            }
        }

        function updateBadge() {
            fetch('/userdashboard/get_cart/')
            .then(res => res.json())
            .then(data => {
                const total = data.items.reduce((s, i) => s + i.quantity, 0);
                document.getElementById('cart-count').innerText = total;
            });
        }

        function loadCart() {
            fetch('/userdashboard/get_cart/')
            .then(res => res.json())
            .then(data => {
                const display = document.getElementById('cart-items-display');
                if(data.items.length === 0) {
                    display.innerHTML = "<div style='background:white; padding:60px; text-align:center; border-radius:12px; box-shadow:var(--shadow);'><i class='fas fa-shopping-cart' style='font-size:3rem; color:#e2e8f0; margin-bottom:15px;'></i><p style='color:#64748b;'>Your shopping cart is currently empty.</p></div>";
                    document.getElementById('cart-checkout-box').style.display = 'none';
                    return;
                }
                
                let html = `<table class="custom-table">
                    <thead><tr><th>Product</th><th>Price</th><th>Quantity</th><th>Subtotal</th></tr></thead>
                    <tbody>`;
                
                data.items.forEach(i => {
                    html += `<tr>
                        <td>
                            <div class="item-cell">
                                <img src="${i.image_url}" class="thumb-img">
                                <div><div style="font-weight:600;">${i.title}</div></div>
                            </div>
                        </td>
                        <td>Rs. ${i.price}</td>
                        <td style="width:140px;">
                            <div class="cart-controls">
                                <button onclick="updateCart('${i.product_id}', 'decrease')"><i class="fas fa-minus"></i></button>
                                <span style="font-weight:bold;">${i.quantity}</span>
                                <button onclick="updateCart('${i.product_id}', 'increase')"><i class="fas fa-plus"></i></button>
                            </div>
                        </td>
                        <td style="font-weight:700;">Rs. ${i.total}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                display.innerHTML = html;
                document.getElementById('cart-total-amount').innerText = data.total_price;
                document.getElementById('cart-checkout-box').style.display = 'block';
            });
        }

        function checkout() {
            fetch('/userdashboard/checkout/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            }).then(() => {
                alert('Success! Your order has been placed.');
                location.reload();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetch('/userdashboard/get_cart/')
            .then(res => res.json())
            .then(data => {
                data.items.forEach(i => renderButton(i.product_id, i.quantity));
                updateBadge();
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('q') || urlParams.has('category') || urlParams.has('min_price') || urlParams.has('max_price')) {
                showSection('collections', document.getElementById('link-collections'));
            }
        });
    </script>
</body>
</html>